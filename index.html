<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>重量計算</title>
<style>
  :root{
    --bd:#2b2b2b;
    --muted:#666;
    --bg:#fff;
    --card:#f6f6f6;
    --radius:14px;
  }
  body{
    font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
    margin:0; background:var(--bg);
  }
  .topbar{
    position:sticky; top:0; z-index:50;
    background:var(--bg);
    border-bottom:1px solid #ddd;
    padding:12px 12px 10px;
  }
  .toprow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .brand{ font-weight:900; font-size:16px; }
  .date{ color:var(--muted); font-size:12px; }

  .card{
    margin-top:10px;
    border:1px solid #ddd;
    border-radius: var(--radius);
    padding:12px;
    background:#fff;
  }
  label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
  input[type="text"], select{
    width:100%;
    padding:12px 12px;
    border:1px solid var(--bd);
    border-radius: var(--radius);
    font-size:16px;
    box-sizing:border-box;
    background:#fff;
  }
  .inline{ display:flex; gap:10px; align-items:center; }
  .inline .floor{ width:38%; min-width:120px; }
  .inline .detail{ flex:1; }

  .sectionTitle{ font-weight:900; font-size:16px; margin:10px 0 0; }
  .hint{ color:var(--muted); font-size:12px; margin:6px 0 0; }

  .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
  button{
    padding:12px 12px;
    border:1px solid var(--bd);
    border-radius: var(--radius);
    background:#fff;
    font-size:14px;
    cursor:pointer;
  }
  button:active{ transform: translateY(1px); }

  .list{
    margin-top:10px;
    border:1px solid #ddd;
    border-radius: var(--radius);
    overflow:hidden;
    background:#fff;
  }
  .row{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-top:1px solid #eee; }
  .row:first-child{ border-top:none; }
  .row.head{ background:#fafafa; font-weight:900; }
  .len{ width:92px; flex:0 0 auto; font-weight:800; }
  .qty{ flex:1; display:flex; align-items:center; justify-content:center; }
  input[type="number"]{
    width:140px;
    padding:12px 10px;
    border:1px solid var(--bd);
    border-radius: var(--radius);
    font-size:18px;
    text-align:center;
    box-sizing:border-box;
  }
  .kg{
    width:92px; flex:0 0 auto;
    text-align:right;
    font-variant-numeric: tabular-nums;
    font-weight:900;
  }
  .muted{ color:var(--muted); font-size:12px; }

  .summary{
    margin-top:10px;
    border:1px solid #ddd;
    border-radius: var(--radius);
    padding:12px;
    background: var(--card);
  }
  .summaryRow{ display:flex; justify-content:space-between; align-items:baseline; padding:6px 0; }
  .summaryRow strong{ font-size:16px; }
  .summaryRow span{ font-variant-numeric: tabular-nums; font-weight:900; }

  details{
    margin-top:10px;
    border:1px solid #ddd;
    border-radius: var(--radius);
    padding:10px 12px;
    background:#fff;
  }
  details summary{ font-weight:900; cursor:pointer; }
  .diaGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px 12px;
    font-variant-numeric: tabular-nums;
  }
  .chip{
    border:1px solid #ddd;
    border-radius: 12px;
    padding:10px 10px;
    background:#fff;
    display:flex; justify-content:space-between; gap:10px;
    font-weight:900;
  }
  .chip small{ color:var(--muted); font-weight:700; }
</style>
</head>

<body>
<div class="topbar">
  <div class="toprow">
    <div class="brand">鵜飼鉄筋工業</div>
    <div id="today" class="date"></div>
  </div>

  <div class="card">
    <label for="work">工事名</label>
    <input id="work" type="text" placeholder="例：牧志テナントビル １壁" autocomplete="off">

    <label for="prime">元請名</label>
    <input id="prime" type="text" placeholder="例：〇〇建設株式会社" autocomplete="off">

    <label>積算内訳（階数 + 内訳）</label>
    <div class="inline">
      <select id="floor" class="floor" aria-label="階数">
        <option value="1F">1F</option><option value="2F">2F</option><option value="3F">3F</option>
        <option value="4F">4F</option><option value="5F">5F</option><option value="6F">6F</option>
        <option value="7F">7F</option><option value="8F">8F</option><option value="9F">9F</option>
        <option value="10F">10F</option><option value="B1F">B1F</option><option value="B2F">B2F</option>
        <option value="RF">RF</option><option value="PH">PH</option>
      </select>
      <input id="detail" class="detail" type="text" placeholder="例：柱・梁・壁など" autocomplete="off">
    </div>

    <div class="controls">
      <button id="btnClear" type="button">本数クリア</button>
      <button id="btnPdfShare" type="button">PDF出力（数量明細）</button>
    </div>
    <div class="muted" style="margin-top:8px;">※PDFはA4 1枚。材長×径の本数表＋径別合計重量（kg）を出します。</div>
  </div>

  <div class="sectionTitle">重量計算</div>
  <div class="hint">径を選んで、材長ごとに本数を入力してください。</div>

  <div class="card" style="margin-top:10px;">
    <label for="dia">径（入力する列）</label>
    <select id="dia"></select>
    <div class="muted" id="kgpm"></div>
  </div>
</div>

<div style="padding: 0 12px 18px;">
  <div class="list" id="list"></div>

  <div class="summary">
    <div class="summaryRow">
      <strong id="thisDiaLabel">この径の重量</strong>
      <div><span id="thisDiaKg">0.000</span> kg</div>
    </div>
    <div class="summaryRow" style="border-top:1px solid #ddd; margin-top:6px; padding-top:10px;">
      <strong>総重量</strong>
      <div><span id="grandKg">0.000</span> kg</div>
    </div>
  </div>

  <details>
    <summary>径別 合計（kg）</summary>
    <div class="diaGrid" id="diaGrid"></div>
  </details>
</div>

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>

<script>
/* =========================
   1) 設定（JIS単位質量）
========================= */
const KG_PER_M = { D10:0.560, D13:0.995, D16:1.560, D19:2.250, D22:3.040, D25:3.980, D29:5.040, D32:6.310 };
const DIAS = Object.keys(KG_PER_M);
const LENGTHS_M = Array.from({length: ((12.0 - 3.5)/0.5)+1}, (_,i)=>+(3.5+0.5*i).toFixed(1));

/* =========================
   2) 状態（マトリクス保持）
========================= */
const qty = {};
for (const m of LENGTHS_M) {
  qty[m] = {};
  for (const d of DIAS) qty[m][d] = 0;
}

/* =========================
   3) DOM参照
========================= */
const diaSel = document.getElementById("dia");
const listEl = document.getElementById("list");
const kgpmEl = document.getElementById("kgpm");
const thisDiaLabelEl = document.getElementById("thisDiaLabel");
const thisDiaKgEl = document.getElementById("thisDiaKg");
const grandKgEl = document.getElementById("grandKg");
const diaGridEl = document.getElementById("diaGrid");

/* =========================
   4) ユーティリティ
========================= */
function fmt3(n){ return (Math.round(n*1000)/1000).toFixed(3); }
function mmLabel(m){ return `${Math.round(m*1000)}mm`; }
function todayStr(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}/${mm}/${dd}`;
}
document.getElementById("today").textContent = todayStr();

function sanitizeFilePart(s){
  return (s || "").replace(/[\\/:*?"<>|]/g, "_").replace(/\s+/g," ").trim();
}
function buildPdfFilename(work, floor, detail, today){
  const uWork = sanitizeFilePart(work) || "工事名未入力";
  const uDetail = sanitizeFilePart((floor || "") + (detail ? " " + detail : "")) || "積算内訳未入力";
  return `${uWork}_${uDetail}_${today}.pdf`.slice(0, 180);
}

/* =========================
   5) 計算
========================= */
function computeSums(){
  const sumByDia = {};
  for (const d of DIAS) sumByDia[d] = 0;

  for (const m of LENGTHS_M) {
    for (const d of DIAS) {
      const q = qty[m][d] || 0;
      if (!q) continue;
      sumByDia[d] += KG_PER_M[d] * m * q;
    }
  }
  const grand = DIAS.reduce((acc,d)=>acc+sumByDia[d],0);
  return { sumByDia, grand };
}

function updateRowKgs(d){
  for (const m of LENGTHS_M) {
    const q = qty[m][d] || 0;
    const kg = KG_PER_M[d] * m * q;
    const cell = listEl.querySelector(`.kg[data-kg="${m}"]`);
    if (cell) cell.textContent = fmt3(kg);
  }
}

function updateTotals(){
  const { sumByDia, grand } = computeSums();
  const dNow = diaSel.value;

  thisDiaLabelEl.textContent = `この径の重量（${dNow}）`;
  thisDiaKgEl.textContent = fmt3(sumByDia[dNow]);
  grandKgEl.textContent = fmt3(grand);

  diaGridEl.innerHTML = DIAS.map(d=>`
    <div class="chip">
      <div>${d}<br><small>${KG_PER_M[d]}kg/m</small></div>
      <div>${fmt3(sumByDia[d])}kg</div>
    </div>
  `).join("");
}

/* =========================
   6) 画面描画（径切替）
========================= */
function renderList(){
  const d = diaSel.value;
  kgpmEl.textContent = `単位質量：${KG_PER_M[d]} kg/m`;

  listEl.innerHTML = `
    <div class="row head">
      <div class="len">材長</div>
      <div class="qty">本数</div>
      <div class="kg">重量</div>
    </div>
    ${LENGTHS_M.map(m=>{
      const v = qty[m][d] || 0;
      return `
        <div class="row">
          <div class="len">${mmLabel(m)}</div>
          <div class="qty">
            <input class="inp" type="number" inputmode="numeric" min="0" step="1"
                   data-l="${m}" value="${v ? v : ""}" placeholder="0">
          </div>
          <div class="kg" data-kg="${m}">0.000</div>
        </div>
      `;
    }).join("")}
  `;

  updateRowKgs(d);
  updateTotals();
}

listEl.addEventListener("input", (e)=>{
  const inp = e.target.closest(".inp");
  if (!inp) return;

  const d = diaSel.value;
  const m = inp.dataset.l;
  const v = parseInt(inp.value || "0", 10) || 0;

  qty[m][d] = v;
  updateRowKgs(d);
  updateTotals();
});

diaSel.addEventListener("change", renderList);

diaSel.innerHTML = DIAS.map(d=>`<option value="${d}">${d}</option>`).join("");
diaSel.value = "D13";

document.getElementById("btnClear").addEventListener("click", ()=>{
  if(!confirm("本数を全部クリアしますか？")) return;
  for (const m of LENGTHS_M) for (const d of DIAS) qty[m][d] = 0;
  renderList();
});

/* =========================
   7) 日本語フォント（TTF）取得
========================= */
const FONT_URLS = [
  "./NotoSansCJKjp-Regular.ttf",
  "https://raw.githubusercontent.com/minoryorg/Noto-Sans-CJK-JP/master/fonts/NotoSansCJKjp-Regular.ttf"
];
let cachedFontBytes = null;

async function getFontBytes(){
  if (cachedFontBytes) return cachedFontBytes;
  let lastErr = null;
  for (const url of FONT_URLS) {
    try {
      const r = await fetch(url, { cache: "force-cache" });
      if (!r.ok) throw new Error(`font fetch failed ${r.status}`);
      cachedFontBytes = await r.arrayBuffer();
      return cachedFontBytes;
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error("font fetch failed");
}

/* =========================
   8) PDF（数量明細：マトリクス表）
   - 外枠太め
   - ヘッダー/合計kg行を薄グレー背景
   - 材長は「xxxxmm」
========================= */
document.getElementById("btnPdfShare").addEventListener("click", async ()=>{
  if (!window.PDFLib || !window.fontkit) {
    alert("PDF機能の読み込みに失敗しました。通信がある状態で再読み込みしてください。");
    return;
  }

  let fontBytes;
  try {
    fontBytes = await getFontBytes();
  } catch (e) {
    console.error(e);
    alert("日本語フォントの取得に失敗しました。\n電波が弱い場合はフォント同梱が確実です。");
    return;
  }

  const work  = (document.getElementById("work").value || "").trim();
  const prime = (document.getElementById("prime").value || "").trim();
  const floor = (document.getElementById("floor").value || "").trim();
  const detail= (document.getElementById("detail").value || "").trim();
  const today = document.getElementById("today").textContent.trim();

  const { sumByDia, grand } = computeSums();

  try {
    const { PDFDocument, rgb } = window.PDFLib;
    const BLACK = rgb(0,0,0);
    const WHITE = rgb(1,1,1);
    const GRAY  = rgb(0.92, 0.92, 0.92); // ヘッダー背景

    const pdfDoc = await PDFDocument.create();
    pdfDoc.registerFontkit(window.fontkit);
    const fontJP = await pdfDoc.embedFont(fontBytes, { subset: false });

    const pageW = 595.28, pageH = 841.89; // A4
    const page = pdfDoc.addPage([pageW, pageH]);

    // レイアウト
    const M = 22;
    let y = pageH - M;

    const titleSize = 14;
    const infoSize  = 10;
    const headSize  = 9;   // 少しUP
    const cellSize  = 8;
    const smallSize = 9;

    const drawLine = () => {
      page.drawLine({ start:{x:M, y}, end:{x:pageW-M, y}, thickness:1, color: BLACK });
      y -= 12;
    };

    // ヘッダー
    page.drawText("鵜飼鉄筋工業", { x: pageW - M - 140, y: y - 10, size: 12, font: fontJP, color: BLACK });
    page.drawText(`日付: ${today}`, { x: pageW - M - 170, y: y - 28, size: 9, font: fontJP, color: BLACK });

    page.drawText("数量明細", { x: M, y: y - 14, size: titleSize, font: fontJP, color: BLACK });
    y -= 34;

    const infoLine = (text) => {
      page.drawText(text, { x: M, y, size: infoSize, font: fontJP, color: BLACK, maxWidth: pageW - M*2, lineHeight: infoSize+3 });
      y -= (infoSize + 6);
    };
    infoLine(`工事名: ${work || "（未入力）"}`);
    infoLine(`元請名: ${prime || "（未入力）"}`);
    infoLine(`積算内訳: ${(floor + (detail ? " / " + detail : "")) || "（未入力）"}`);

    y -= 6;
    drawLine();

    // ===== 表（右端の合計列なし）=====
    const wLen = 70;      // 材長列を少し広く（mm表示のため）
    const wDia = 50;
    const tableW = wLen + wDia*DIAS.length;

    const hHead = 20;     // 少し高さUP
    const hRow  = 16;

    const tx = M;
    const ty = y;

    const tableH = hHead + (hRow * LENGTHS_M.length) + hHead; // 最下段は合計kg

    // 外枠（太め）
    page.drawRectangle({
      x: tx, y: ty - tableH, width: tableW, height: tableH,
      color: WHITE,
      borderColor: BLACK,
      borderWidth: 2,         // ★外枠太く
      opacity: 1, borderOpacity: 1
    });

    // ヘッダー背景（上）
    page.drawRectangle({
      x: tx, y: ty - hHead, width: tableW, height: hHead,
      color: GRAY, borderWidth: 0
    });

    // 合計kg行の背景（下）
    page.drawRectangle({
      x: tx, y: (ty - tableH), width: tableW, height: hHead,
      color: GRAY, borderWidth: 0
    });

    // 罫線（内側）
    const lineH = (yy, thick=0.6) => page.drawLine({ start:{x:tx, y:yy}, end:{x:tx+tableW, y:yy}, thickness:thick, color: BLACK });
    const lineV = (xx, thick=0.6) => page.drawLine({ start:{x:xx, y:ty}, end:{x:xx, y:ty-tableH}, thickness:thick, color: BLACK });

    // 縦線
    lineV(tx, 1);
    lineV(tx + wLen, 1);
    for (let i=0;i<DIAS.length;i++) lineV(tx + wLen + wDia*(i+1), 0.6);

    // 横線
    lineH(ty, 1);
    lineH(ty - hHead, 1); // ヘッダー区切り
    for (let r=0;r<LENGTHS_M.length;r++){
      lineH(ty - hHead - hRow*(r+1), 0.5);
    }
    lineH(ty - hHead - hRow*LENGTHS_M.length, 1); // 合計kgの上を強め
    lineH(ty - tableH, 1);

    // 中央寄せ（簡易）
    const centerText = (text, cx, cy, size) => {
      const approxW = text.length * size * 0.55;
      page.drawText(text, { x: cx - approxW/2, y: cy - size/2, size, font: fontJP, color: BLACK });
    };

    // ヘッダー（材長 + 径）
    const hy = ty - hHead/2;
    centerText("材長", tx + wLen/2, hy, headSize);
    for (let i=0;i<DIAS.length;i++){
      centerText(DIAS[i], tx + wLen + wDia*(i+0.5), hy, headSize);
    }

    // 本体（材長は mm を付ける）
    for (let r=0;r<LENGTHS_M.length;r++){
      const m = LENGTHS_M[r];
      const cy = ty - hHead - hRow*r - hRow/2;

      const mm = Math.round(m*1000);
      centerText(`${mm}mm`, tx + wLen/2, cy, cellSize); // ★単位(mm)

      for (let c=0;c<DIAS.length;c++){
        const d = DIAS[c];
        const q = qty[m][d] || 0;
        if (q !== 0) centerText(String(q), tx + wLen + wDia*(c+0.5), cy, cellSize);
      }
    }

    // 最下段：径別 合計重量（kg）
    const sy = ty - hHead - hRow*LENGTHS_M.length - hHead/2;
    centerText("合計kg", tx + wLen/2, sy, headSize);
    for (let c=0;c<DIAS.length;c++){
      const d = DIAS[c];
      const kg = sumByDia[d] || 0;
      if (kg !== 0) centerText(kg.toFixed(3), tx + wLen + wDia*(c+0.5), sy, headSize);
    }

    // 下：総重量
    let by = (ty - tableH) - 14;
    page.drawText(`総重量: ${grand.toFixed(3)} kg`, { x: M, y: by, size: smallSize, font: fontJP, color: BLACK });
    page.drawText("※ 表セルは本数（0は空欄）。最下段は径別合計重量（kg）。", { x: M, y: M + 8, size: 9, font: fontJP, color: BLACK });

    // 出力
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type:"application/pdf" });
    const url = URL.createObjectURL(blob);

    const filename = buildPdfFilename(work, floor, detail, today);
    let shared = false;

    if (navigator.share) {
      try {
        const file = new File([blob], filename, {type:"application/pdf"});
        if (navigator.canShare && navigator.canShare({files:[file]})) {
          await navigator.share({ title:"数量明細 PDF", files:[file] });
          shared = true;
        }
      } catch (_) {}

      if (!shared) {
        try {
          await navigator.share({ title:"数量明細 PDF", url });
          shared = true;
        } catch (_) {}
      }
    }

    if (!shared) {
      const opened = window.open(url, "_blank");
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();

      alert(opened
        ? "PDFを開きました。PDF画面の共有から別アプリへ出力できます。"
        : "PDFをダウンロードしました。「ファイル」から開いて共有してください。"
      );
    }

    setTimeout(()=>URL.revokeObjectURL(url), 15000);

  } catch (e) {
    console.error(e);
    alert("PDF出力に失敗しました。\n理由: " + (e?.message || e));
  }
});

/* 初期描画 */
renderList();
</script>
</body>
</html>
